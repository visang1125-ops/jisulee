# 사용자 지침 정리 (MECE)

## 1. 개발 원칙 및 규칙

### 1.1 구현 작업 원칙
- **테스트 우선 개발 (TDD)**
  - 비즈니스 로직 구현 작업은 반드시 테스트를 먼저 작성하고 구현
  - 테스트 없이는 개발하지 않음

- **SOLID 원칙 준수**
  - 단일 책임 원칙 (SRP)
  - 개방-폐쇄 원칙 (OCP)
  - 리스코프 치환 원칙 (LSP)
  - 인터페이스 분리 원칙 (ISP)
  - 의존성 역전 원칙 (DIP)

- **Clean Architecture 적용**
  - 계층 분리 (Presentation, Business Logic, Data)
  - 의존성 방향 준수
  - 도메인 로직과 인프라 분리

- **설정 파일 문서화**
  - Pulumi나 CloudFormation에 설정하는 Description은 영문으로 작성

### 1.2 코드 품질 원칙
- **단순성 우선**
  - 언제나 복잡한 솔루션보다 가장 단순한 솔루션을 우선시
  - 과도한 추상화 지양

- **중복 방지 (DRY 원칙)**
  - 코드 중복을 피하고, 가능한 기존 기능을 재사용
  - 공통 로직은 유틸리티 함수로 추출

- **가드레일 준수**
  - 테스트 외에는 개발이나 프로덕션 환경에서 모의 데이터를 사용하지 않음
  - 실제 데이터만 사용

- **효율성**
  - 명확성을 희생하지 않으면서 토큰 사용을 최소화하도록 출력을 최적화

## 2. 리팩토링 규칙

### 2.1 리팩토링 프로세스
- **사전 계획 및 승인**
  - 리팩토링이 필요한 경우 계획을 설명하고 허락을 받은 다음 진행
  - 코드 구조를 개선하는 것이 목표이며, 기능 변경은 아님

- **리팩토링 후 검증**
  - 리팩토링 후에는 모든 테스트가 통과하는지 확인
  - 기능 동작 검증 필수

## 3. 디버깅 규칙

### 3.1 디버깅 프로세스
- **원인 분석 및 해결책 제시**
  - 디버깅 시에는 원인 및 해결책을 설명하고 허락을 받은 다음 진행
  - 에러 해결이 중요한 것이 아니라 제대로 동작하는 것이 중요

- **로깅 전략**
  - 원인이 불분명할 경우 분석을 위해 상세 로그를 추가
  - 디버깅을 위한 충분한 정보 제공

## 4. 기능 요구사항

### 4.1 데이터 필드 관리
- **필수 필드**
  - `프로젝트명` (projectName): 필수 필드
  - `산정근거/집행내역` (calculationBasis): 필수 필드 (기존 `적요` 필드 대체)

- **필드 제거**
  - `적요` (description) 필드 완전 제거
  - 모든 관련 코드에서 제거 완료

- **새 필드 추가**
  - `예산 내/외` (isWithinBudget): 예산 내/외 구분
  - `사업구분` (businessDivision): 키즈, 초등, 중등, 전체
  - `프로젝트명/세부항목` (projectName): 프로젝트명/세부항목
  - `산정근거/집행내역` (calculationBasis): 산정근거/집행내역
  - `고정비/변동비` (costType): 고정비/변동비

### 4.2 엑셀 파일 형식
- **컬럼 구조**
  - `구분` 컬럼: "예산", "계획", "실제", "집행" 중 하나
  - `금액` 컬럼: 단일 금액 컬럼 (예산과 실제를 별도 컬럼이 아닌 구분으로 나눔)
  - `프로젝트명/세부항목` 컬럼: 필수
  - `산정근거/집행내역` 컬럼: 필수

- **데이터 그룹화**
  - 같은 키(부서+계정과목+월+연도+프로젝트명+산정근거)로 그룹화
  - "예산"과 "실제" 행을 하나의 BudgetEntry로 합침

### 4.3 데이터 관리 기능
- **실시간 엑셀 파일 동기화**
  - 엑셀 파일 변경 시 자동으로 데이터 재로드
  - 파일 감시 기능으로 실시간 반영

- **결산 내역 추가 시 엑셀 저장**
  - 결산 내역 추가/수정/삭제 시 엑셀 파일에 자동 저장
  - 메모리와 엑셀 파일 동기화 유지

- **샘플 데이터 제거**
  - 샘플 데이터 제거, 엑셀 파일에서만 데이터 로드
  - 엑셀 파일이 없으면 빈 상태로 시작

### 4.4 결산 내역 관리
- **결산 내역 추가 기능**
  - 웹 인터페이스에서 "예산 외" 결산 내역 추가 가능
  - 필수 필드: 부서, 계정과목, 연도, 월, 프로젝트명, 산정근거/집행내역, 실제 금액
  - 선택 필드: 사업구분, 고정비/변동비

- **예산 내/외 처리**
  - "예산 내" 항목: 기존 예산에 포함된 항목
  - "예산 외" 항목: 결산 내역 추가로 추가된 항목 (예산 금액 0)

## 5. UI/UX 요구사항

### 5.1 대시보드 개선
- **KPI 카드 개선**
  - 총 예산 카드에 결산 마감월 기준 예산 금액 툴팁 추가
  - 집행률 카드에 결산 마감월 기준 예산 및 집행 금액 병기
  - n개월 기준과 줄바꿈으로 표시

- **예산 vs 실제 비교 차트**
  - C-level 책임자가 개별적으로 확인하기 용이한 자료
  - 예산 집행 실무자가 확인하기 용이한 자료
  - 정보 밀도 향상 (덜 빈약하게)
  - 집행률을 중심으로 표시
  - 상세 지표 및 리스크 항목 표시

- **결산 마감월 선택**
  - 대시보드 상단에 결산 마감월을 지정하는 드롭박스 추가
  - 필터와 독립적으로 관리

### 5.2 데이터 표시 명확성
- **예산 개념 구분**
  - 총 예산 (연간 전체 예산)
  - 결산 마감월 기준의 예산
  - 필터 기준의 누적 예산
  - 각각을 명확히 구분하여 표시

- **집행률 표시**
  - 집행률이 들어간 부분은 모두 툴팁으로 상세 정보 제공
  - 퍼센테이지가 오해될 소지가 있는 부분 명확화

### 5.3 접근성
- **툴팁 설정**
  - 총 예산 카드에 툴팁 추가 (delayDuration={0}로 즉시 표시)
  - 모든 집행률 관련 표시에 상세 정보 제공

### 5.4 차트 개선
- **도넛 차트**
  - 텍스트 겹침 문제 해결
  - 공간 활용 개선
  - 집행률 중심으로 간소화

## 6. 성능 및 최적화

### 6.1 React 성능 최적화
- **메모이제이션 적용**
  - `useMemo`로 계산 결과 캐싱
  - `useCallback`으로 함수 메모이제이션
  - 불필요한 재렌더링 방지

- **데이터 로딩 최적화**
  - Dashboard에서 전체 데이터를 두 번 로드하지 않도록 최적화
  - 계산 함수들이 매 렌더링마다 실행되지 않도록 메모이제이션

## 7. 코드 구조 및 아키텍처

### 7.1 중복 코드 제거
- **상수 통합**
  - 부서/계정과목 목록이 여러 파일에 중복 정의되지 않도록 공통 유틸리티로 통합
  - 단일 소스에서 관리

- **유효성 검사 로직 공통화**
  - `ImportPreviewDialog`와 `server/storage.ts`의 유효성 검사 로직 중복 제거
  - 공통 유틸리티 함수로 추출

### 7.2 타입 안정성
- **타입 정의 강화**
  - `any` 타입 사용 금지
  - 엄격한 타입 정의
  - Zod 스키마로 런타임 검증

### 7.3 에러 메시지 관리
- **메시지 상수화**
  - 에러 메시지 상수화 및 일관성 유지
  - 한글/영문 혼재 방지
  - 에러 메시지 상수 파일로 관리

### 7.4 매직 넘버/문자열 제거
- **상수화**
  - 하드코딩된 값들을 상수로 추출
  - API 관련 상수 (재시도 횟수, 타임아웃 등) 별도 파일로 관리

### 7.5 함수 크기 관리
- **함수 분리**
  - 큰 함수(200+ 줄)를 작은 함수로 분리
  - 단일 책임 원칙 준수

### 7.6 문서화
- **JSDoc 주석**
  - 공개 API에 JSDoc 추가
  - 함수 목적, 매개변수, 반환값 명시

## 8. 데이터 검증 및 에러 처리

### 8.1 엑셀 파일 검증
- **필수 필드 검증**
  - 부서, 계정과목, 프로젝트명, 산정근거/집행내역, 구분 필수
  - 필수 필드 누락 시 해당 행 건너뛰기 및 경고 로그

- **데이터 타입 검증**
  - 부서, 계정과목이 유효한 값인지 확인
  - 구분 값이 "예산", "계획", "실제", "집행" 중 하나인지 확인
  - 월은 1-12 사이인지 확인
  - 금액은 0 이상인지 확인

- **에러 로깅**
  - 각 행별 상세 에러 로깅
  - 실패한 행 번호와 이유를 로그에 기록

### 8.2 부서/계정과목 동적 관리
- **하드코딩 제거**
  - 부서와 계정과목이 코드에 하드코딩되어 있어 엑셀 파일의 새 항목이 자동 반영 안 되는 문제 해결
  - 엑셀 파일에서 동적으로 부서/계정과목 목록 추출 (향후 개선)

## 9. 보고서 및 분석

### 9.1 보고서 페이지
- **결산 기준월 예산 표시**
  - 보고서 페이지에서 결산 기준월의 예산도 표시
  - 모든 분석 페이지에서 일관성 유지

### 9.2 부서별/계정과목별 분석
- **결산 기준월 예산 포함**
  - 부서별 분석, 계정과목별 분석에서도 결산 기준월 예산 표시
  - 일관된 데이터 표시

## 10. 파일 관리

### 10.1 엑셀 파일 경로
- **기본 경로**
  - `data/budget.xlsx` 파일 사용
  - 서버 시작 시 자동 로드

### 10.2 파일 감시
- **실시간 동기화**
  - 파일 변경 감지 시 자동 재로드
  - Windows 환경에서 안정적으로 동작하도록 개선
  - 파일 직접 감시 우선, 실패 시 디렉토리 감시로 폴백

## 11. 부서 관리

### 11.1 부서 추가
- **동적 부서 지원**
  - "러닝마케팅 Core" 등 새 부서 추가 시 코드 수정 필요
  - 현재는 `DEPARTMENTS` 상수에 추가 필요 (향후 동적 로드로 개선)

## 12. 데이터 일관성

### 12.1 MECE 관점에서의 수정
- **총체적인 수정/고도화**
  - 처음 자료를 보는 사람도 오해가 없도록 MECE 관점에서 총체적인 수정/고도화
  - 예산 개념 명확화 (총 예산, 결산 마감월 기준 예산, 필터 기준 누적 예산)

## 13. 개선점 도출 및 반영

### 13.1 개선점 도출
- **시스템 전반 분석**
  - 코드베이스 전반을 분석하여 개선점 도출
  - 우선순위에 따라 개선사항 반영

### 13.2 리팩토링
- **코드 품질 개선**
  - 성능 최적화
  - 중복 코드 제거
  - 타입 안정성 개선
  - 에러 메시지 상수화
  - 매직 넘버/문자열 상수화
  - 엑셀 파싱 로직 리팩토링
  - 유효성 검사 로직 공통화

---

## 카테고리별 요약

### 필수 준수 사항 (Must)
1. 테스트 우선 개발
2. SOLID 원칙
3. Clean Architecture
4. 필수 필드 검증 (프로젝트명, 산정근거/집행내역)
5. 엑셀 파일 실시간 동기화
6. 결산 내역 추가 시 엑셀 저장

### 중요 개선 사항 (Should)
1. 성능 최적화 (useMemo, useCallback)
2. 중복 코드 제거
3. 타입 안정성 강화
4. 에러 메시지 상수화
5. UI/UX 개선 (대시보드, 차트)

### 권장 사항 (Nice to Have)
1. 부서/계정과목 동적 로드
2. 테스트 코드 추가
3. 접근성 개선
4. 문서화 강화


